---
title: "Analysis of World Happiness"

date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
    number_sections: yes
    theme: lumen
  pdf_document:
    toc: yes
    toc_depth: '3'
---
<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 38px;
  color: lightblue;
  font-weight: bold;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: DarkBlue;
}
h2 { /* Header 2 */
  font-size: 20px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 16px;
#  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
h4 { /* Header 4 */
  font-size: 14px;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 12px;
}
</style>


```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo=TRUE, results='hold', warning=FALSE, fig.show='hold', message=FALSE) 
options(scipen = 99)
```



# Introduction



## objective

Our main goal is to do an exploratory analysis of the factors that make people happy.



# Data preprocessing

```{r}

```

## Dataset


Abalone Physical Measurements
Source: https://www.kaggle.com/rodolfomendes/abalone-dataset


## Load Libraries

```{r}
#install.packages('tidyverse')
#install.packages('skimr')
#install.packages('ggpubr')
#install.packages("caret")
#install.packages("Metrics")
#install.packages("e1071")

library(Metrics)
library(caret)
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(skimr)
library(tidyr)
library(reshape2)
library(ggpubr)
library(stringr)
library(e1071)
library(pROC)


```

## Load the data
```{r}
# df = read_excel("World Hapiness Data (2015-2019).xlsx", sheet = "Sheet1")
happy15_df = read.csv ("data/2015.csv")
happy16_df = read.csv ("data/2016.csv")
happy17_df = read.csv ("data/2017.csv")
happy18_df = read.csv ("data/2018.csv")
happy19_df = read.csv ("data/2019.csv")
head(happy19_df)

```

We have a look at the last one (head is by default with the first 5 rows)

## Explore Dataset



#### <a style="color:blue;">Change year 2018 datasets column names base year 2017 datasets</a>

```{r}


happy18_df=plyr::rename(happy18_df, replace = c( "Country.or.region"="Country", 
                                  "Overall.rank"="Happiness.Rank" ,
                                  "GDP.per.capita"="Economy..GDP.per.Capita.",
                                  "Healthy.life.expectancy"="Health..Life.Expectancy.",
                                  "Freedom.to.make.life.choices"="Freedom",
                                  "Perceptions.of.corruption"="Trust..Government.Corruption.",
                                  "Social.support"="Family",
                                  "Score"="Happiness.Score"))


colnames(happy18_df)


```


#### <a style="color:blue;">Change year 2019 datasets column names base year 2017 datasets</a>

```{r}

happy19_df=plyr::rename(happy19_df, replace = c( "Country.or.region"="Country", 
                                  "Overall.rank"="Happiness.Rank" ,
                                  "GDP.per.capita"="Economy..GDP.per.Capita.",
                                  "Healthy.life.expectancy"="Health..Life.Expectancy.",
                                  "Freedom.to.make.life.choices"="Freedom",
                                  "Perceptions.of.corruption"="Trust..Government.Corruption.",
                                  "Social.support"="Family",
                                  "Score"="Happiness.Score"))

colnames(happy19_df)

```

#### <a style="color:blue;">Change year 2015 datasets column names base year 2017 datasets</a>

```{r}
happy15_df=plyr::rename(happy15_df, replace = c( "Happiness Rank" = "Happiness.Rank", 
                                  "Happiness Score" = "Happiness.Score",
                                  "Economy (GDP per Capita)" = "Economy..GDP.per.Capita.",
                                  "Health (Life Expectancy)" = "Health..Life.Expectancy.",
                                  "Trust (Government Corruption)"  = "Trust..Government.Corruption.",
                                  "Dystopia Residual"="Dystopia.Residual"
                                  ))

colnames(happy15_df)


```


#### <a style="color:blue;">Change year 2016 datasets column names base year 2017 datasets</a>


```{r}

happy16_df=plyr::rename(happy16_df, replace = c( "Happiness Rank" = "Happiness.Rank", 
                                  "Happiness Score" = "Happiness.Score",
                                  "Economy (GDP per Capita)" = "Economy..GDP.per.Capita.",
                                  "Health (Life Expectancy)" = "Health..Life.Expectancy.",
                                  "Trust (Government Corruption)"  = "Trust..Government.Corruption.",
                                  "Dystopia Residual"="Dystopia.Residual"
                                  ))

colnames(happy16_df)


```

#### <a style="color:blue;">insert year column at first position (index 0)</a>

```{r}
#2015

happy15_df<-cbind(Year=2015,happy15_df)

happy16_df<-cbind(Year=2016,happy16_df)

happy17_df<-cbind(Year=2017,happy17_df)

happy18_df<-cbind(Year=2018,happy18_df)

happy19_df<-cbind(Year=2019,happy19_df)



```
## change column type
```{r}
happy18_df$Trust..Government.Corruption. = as.numeric(happy18_df$Trust..Government.Corruption.)

str(happy18_df)

```


## merge data from 2015-2019


```{r}



happy15_16<-dplyr::bind_rows(happy15_df,happy16_df)

happy15_16_17<-dplyr::bind_rows(happy15_16,happy17_df)


happy18_19<-dplyr::bind_rows(happy18_df,happy19_df)


df<-dplyr::bind_rows(happy18_19,happy15_16_17)

head(df)

```



## change column data type

```{r}
df$Happiness.Rank  = as.numeric(df$Happiness.Rank )


str(df)
```



## Remove unnessesary columns
```{r}

colSums(is.na(df))



```


```{r}

df = subset(df, select = -c(Lower.Confidence.Interval,Upper.Confidence.Interval,Dystopia.Residual,Standard.Error,Whisker.high,Whisker.low))

head(df)
```


## Impute with mean or median values for numerical columns.

```{r}


df$Trust..Government.Corruption.[is.na(df$Trust..Government.Corruption.)] <- median(df$Trust..Government.Corruption., na.rm = T)

colSums(is.na(df))

```




## Filter uncommon data in Country Column

Due to the data is describing the happiness score and relative factors for countries accross different years. So, it is important to view the uniformity of the data in Year column of the data.


Country and Region counts groupby Year

```{r}
aggregate(df$Country, by=list(df$Year), FUN=length)
```

From the table shown as above, the number of countries involved in this dataset for different year is differnt. Therefore, it is neccessary to make an intersection of them to get the most common country list.

```{r}

Country_2015 = subset(df, Year == 2015)$Country
Country_2016 = subset(df, Year == 2016)$Country
Country_2017 = subset(df, Year == 2017)$Country
Country_2018 = subset(df, Year == 2018)$Country
Country_2019 = subset(df, Year == 2019)$Country


```

```{r}
common_country =intersect(intersect(intersect(intersect(Country_2015, Country_2016),Country_2017),Country_2018),Country_2019)
length(common_country)
```
Therefore, there are 142 countries' data existing accross from 2015-2019 in this dataset.Then we need to filter the orginial dataset by this common_country list.
```{r}

df1 = subset(df,Country %in% common_country)
print(paste("The amount of rows in the dataset is: ",dim(df1)[1]))
print(paste("The amount of columns in the dataset is: ",dim(df1)[2]))

```
```{r}
str(df1)
```




## Fill value for categorical columns




Create a new dataset for storing common region and country

```{r}

common_region <- unique(subset(df1, Region!="NA", c(Country, Region)))

head(common_country)

```

Fill relate region to missing value of region column


```{r}

assign_region <- function(x){
  
  Region <- common_region$Region[common_region$Country == x]
  
}


for(country in common_country)

      df1$Region[df1$Country == country] <- assign_region(country)
      


```




## Save cleaned dataset

```{r}
# write_csv(df1, path = "World Hapiness Data (2015-2019)_cleaned.csv")

```





### briefly statistic view the data


```{r}
skimr::skim_without_charts(df1)

```

```{r}
print(paste("The amount of rows in the dataset is: ",dim(df)[1]))
print(paste("The amount of columns in the dataset is: ",dim(df)[2]))
print(paste("the column names in this dataset are:", paste(shQuote(colnames(df)), collapse=", ")))
```




# Exploratary Data Analysis


The 10 happiest countries in 2015

```{r}
df1 %>%
  filter(Year == 2015) %>%
  arrange(-Happiness.Score) %>%
  slice_head(n=10) %>%
  ggplot(aes(reorder(Country, Happiness.Score), Happiness.Score)) +
  geom_point(colour = "red", size = 3) +
  theme(text=element_text(size=10)) + 
  coord_flip() +
  labs(title = "The 10 happiest countries in 2015", x = "")


```

The 10 happiest countries in 2016

```{r}
df1 %>%
  filter(Year == 2016) %>%
  arrange(-Happiness.Score) %>%
  slice_head(n=10) %>%
  ggplot(aes(reorder(Country, Happiness.Score), Happiness.Score)) +
  geom_point(colour = "red", size = 3) +
  theme(text=element_text(size=10)) + 
  coord_flip() +
  labs(title = "The 10 happiest countries in 2016", x = "")


```

The 10 happiest countries in 2017

```{r}
df1 %>%
  filter(Year == 2017) %>%
  arrange(-Happiness.Score) %>%
  slice_head(n=10) %>%
  ggplot(aes(reorder(Country, Happiness.Score), Happiness.Score)) +
  geom_point(colour = "red", size = 3) +
  theme(text=element_text(size=10)) + 
  coord_flip() +
  labs(title = "The 10 happiest countries in 2017", x = "")


```

The 10 happiest countries in 2018

```{r}
df1 %>%
  filter(Year == 2018) %>%
  arrange(-Happiness.Score) %>%
  slice_head(n=10) %>%
  ggplot(aes(reorder(Country, Happiness.Score), Happiness.Score)) +
  geom_point(colour = "red", size = 3) +
  theme(text=element_text(size=10)) + 
  coord_flip() +
  labs(title = "The 10 happiest countries in 2018", x = "")


```

The 10 happiest countries in 2019

```{r}
df1 %>%
  filter(Year == 2019) %>%
  arrange(-Happiness.Score) %>%
  slice_head(n=10) %>%
  ggplot(aes(reorder(Country, Happiness.Score), Happiness.Score)) +
  geom_point(colour = "red", size = 3) +
  theme(text=element_text(size=10)) + 
  coord_flip() +
  labs(title = "The 10 happiest countries in 2019", x = "")


```



```{r}
Region_Yearavg_HappyScore = data.frame(aggregate(df$Happiness.Score, by=list(df$Year,df$Region), FUN=mean))
colnames(Region_Yearavg_HappyScore)<-c("Year","Region","Mean_HappyScore")
Region_Yearavg_HappyScore
```

```{r}

ggplot(Region_Yearavg_HappyScore,aes(x = Year,y = Mean_HappyScore,fill = Region))+
  geom_bar(stat = "identity",position = "dodge")
```

The top 3 happiness region are: Australia and New Zealand, North America and Western Europe


## from 2015 to 2019, Mean Happiness score by regions:
```{r}
df1 %>%
  group_by(Region) %>%
  summarise(mscore = mean(Happiness.Score)) %>%
  ggplot(aes(reorder(Region, mscore), mscore)) +
  geom_point() +
  theme_bw() +
  
  coord_flip() +
  labs(title = "Happiness Score by Regions",
       x = "", y = "Average happiness score")

```



## from 2015 to 2019, Mean Happiness score by counntries:
```{r}
df1 %>%
  group_by(Country) %>%
  summarise(mscore = mean(Happiness.Score)) %>%
  arrange(-mscore) %>%
  slice_head(n=10) %>%
  
  ggplot(aes(reorder(Country, mscore), mscore)) +
  geom_point() +
  theme_bw() +
  
  coord_flip() +
  labs(title = "Happiness Score by Country",
       x = "", y = "Average happiness score")
```
Top 10 Mean Happiness score by counntries trends by years

```{r}
Top10_happy_country_DF = df1 %>%
  group_by(Country) %>%
  summarise(mscore = mean(Happiness.Score)) %>%
  arrange(-mscore) %>%
  slice_head(n=10)

Top10_happy_country_DF_list = c(Top10_happy_country_DF$Country)

df1_Top10_happy_country = subset(df1,Country %in% Top10_happy_country_DF_list)

ggplot(df1_Top10_happy_country,  aes(x = Year,y = Happiness.Score,color = Country))+  geom_line()

```
## The happiness socre of Finland is increasing dramatically from 2015-2019


### The 10 most progressive countries from 2015 - 2017:
```{r}
df1 %>%
  mutate(y = as.character(Year)) %>%
  select(y, Country, Region, Happiness.Score) %>%
  pivot_wider(names_from = y, values_from = Happiness.Score,
              names_prefix = "y_") %>%
  mutate(p = (y_2019 - y_2015)/y_2015 * 100) %>%
  arrange(-p) %>%
  slice_head(n = 10) %>%
  ggplot(aes(reorder(Country, p), p)) +
  geom_point() +
  theme_bw() +
  coord_flip() +
  labs(title = "The 10 most progressive countries from 2015 - 2019",
       y = "Percentage Increase of Happiness Score", x = "")
```

```{r}
Top10_Progress_country_df = df1 %>%
  mutate(y = as.character(Year)) %>%
  select(y, Country, Region, Happiness.Score) %>%
  pivot_wider(names_from = y, values_from = Happiness.Score,
              names_prefix = "y_") %>%
  mutate(p = (y_2019 - y_2015)/y_2015 * 100) %>%
  arrange(-p) %>%
  slice_head(n = 10)

Top10_Progress_country_df_list = c(Top10_Progress_country_df$Country)

df1_Top10_Progress_country = subset(df1,Country %in% Top10_Progress_country_df_list)

ggplot(df1_Top10_Progress_country,  aes(x = Year,y = Happiness.Score,color = Country))+  geom_line()


```

```{r}
head(df1)
```
```{r}
df1 %>%
  summarise(gdp = mean(Economy..GDP.per.Capita.),
            family = mean(Family),
            life.expectancy = mean(Health..Life.Expectancy.),
            freedom = mean(Freedom),
            generosity = mean(Generosity),
            corruption = mean(Trust..Government.Corruption.)) %>%
  pivot_longer(c(gdp, family, life.expectancy,freedom,generosity, corruption),
               names_to = "f", values_to = "value") %>%
  ggplot(aes(reorder(f, value), value)) +
  geom_bar(stat = "identity", fill = "darkgreen", width = 0.55, alpha = 0.7) +
  geom_text(aes(label = paste0(round(value, 2)), vjust = -0.5)) +
  theme_bw() +
  labs(title = "The mean value of the factors" , y = "", x = "")
```

```{r}
Happiness.Continent <- df1 %>%
                          select(-c(Year,Happiness.Rank))%>%
                          group_by(Region) %>%
                          summarise_at(vars(-Country), funs(mean(., na.rm=TRUE)))


Happiness.Continent.melt <- melt(Happiness.Continent)


# Faceting
ggplot(Happiness.Continent.melt, aes(y=value, x=Region, color=Region, fill=Region)) + 
  geom_bar( stat="identity") +    
  facet_wrap(~variable) + theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Average value of happiness variables for different continents", 
       y = "Average value") 
```


```{r}
####### Happiness score for each continent

gg1 <- ggplot(df1,
              aes(x=Region,
                  y=Happiness.Score,
                  color=Region))+
  geom_point() + theme_bw() +
  theme(axis.text.x = element_text(angle = 90))

gg1

```




```{r}
gg2 <- ggplot(df1 , aes(x = Region, y = Happiness.Score)) +
  geom_boxplot(aes(fill=Region)) + theme_bw() +
  theme(axis.text.x = element_text (angle = 90))

gg2
```


```{r}
colnames(df1)
```
```{r}
ggline1 = ggplot(df1, aes(x = Economy..GDP.per.Capita., y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline1a = ggplot(df1, aes(x = Economy..GDP.per.Capita., y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline1
ggline1a
```


```{r}
ggline2 = ggplot(df1, aes(x = Family, y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline2a = ggplot(df1, aes(x = Family, y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline2
ggline2a
```


```{r}
ggline3 = ggplot(df1, aes(x = Health..Life.Expectancy., y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline3a = ggplot(df1, aes(x = Health..Life.Expectancy., y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline3
ggline3a
  
```


```{r}
ggline4 = ggplot(df1, aes(x =Freedom, y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline4a = ggplot(df1, aes(x =Freedom, y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline4
ggline4a


```


```{r}
ggline5 = ggplot(df1, aes(x = Trust..Government.Corruption., y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline5a = ggplot(df1, aes(x = Trust..Government.Corruption., y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline5
ggline5a


```
```{r}
ggline6 = ggplot(df1, aes(x = Generosity, y = Happiness.Score)) + 
  geom_point(size = .5, alpha = 0.8) +  
  geom_smooth(method = "lm", fullrange = TRUE) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline6a = ggplot(df1, aes(x = Generosity, y = Happiness.Score)) + 
  geom_point(aes(color=Region), size = .5, alpha = 0.8) +  
  geom_smooth(aes(color = Region, fill = Region), 
              method = "lm", fullrange = TRUE) +
  facet_wrap(~Region) +
  theme_bw() + labs(title = "Scatter plot with regression line")

ggline6
ggline6a
```



### Correlation Matrix Heatmap

```{r}
 library(corrplot)
 Num.cols <- sapply(df1, is.numeric)
 Cor.data <- cor(df1[, Num.cols])

 corrplot(Cor.data, method = 'color') 
 
```


```{r}
library(GGally)

ggcorr(df1, label = TRUE, label_round = 2, label_size = 3.5, size = 2, hjust = .85) +
  ggtitle("Correlation Heatmap") +
  theme(plot.title = element_text(hjust = 0.5))
```


## Drop columns based on heatmap Correlation

Based on the heatmap, we should drop Year,Country,Happiness.Rank,Region column


```{r}

dataset= select(df1,-c("Year","Country","Happiness.Rank","Region"))
head(dataset)
```


## Categorize Happiness score into 3 level:

- High, Mid, low 
- Add new column Happy.Level into dataset

```{r}



rge_dif=round((max(dataset$Happiness.Score)-min(dataset$Happiness.Score))/3,3)

low=min(dataset$Happiness.Score)+rge_dif
mid=low+rge_dif


print(paste("range difference in happiness score: ",rge_dif))
print(paste('upper bound of Low grp',low))
print(paste('upper bound of Mid grp',mid))
print(paste('upper bound of High grp','max:',max(dataset$Happiness.Score)))



```

“Happy.Level” columns ⟶ transformed from “”Happiness.Score column.

```{r}

dataset_level <- dataset %>%
  mutate(Happy.Level=case_when(
    Happiness.Score <=low  ~ "Low",
    Happiness.Score>low & Happiness.Score <=mid ~ "Mid",
    Happiness.Score >mid ~ "High"
  ))  %>%
  mutate(Happy.Level=factor(Happy.Level, levels=c("High", "Mid", "Low"))) %>%
  select(-Happiness.Score)

```



# Data Modelling by Regression Algorithm




## Split into train set (80%) and test set (20%) 



```{r}

# Splitting the dataset into the Training set and Test set
set.seed(123) 
split=0.80
trainIndex <- createDataPartition(dataset$Happiness.Score, p=split, list=FALSE) 
data_train <- dataset[ trainIndex,] 
data_test <- dataset[-trainIndex,]


```




## Multiple Linear Regression for Happyniess Score Prediction
 
 
### Train Multiple Linear Regression model with data_train 


```{r}

# Fitting Multiple Linear Regression to the Training set
lm_model = lm(formula = Happiness.Score ~ .,
               data = data_train)

summary(lm_model)


```


An (adjusted) R2 that is close to 1 indicates that a large proportion of the variability in the outcome has been explained by the regression model.

A number near 0 indicates that the regression model did not explain much of the variability in the outcome.

Our adjusted R2 is 0.7697, which is good.



### Predict datat_test happiness score by Multiple Linear Regression model

```{r}
y_pred_lm = predict(lm_model, newdata = data_test)
Actual_lm = data_test$Happiness.Score

Pred_Actual_lm <- as.data.frame(cbind(Prediction = y_pred_lm, Actual = Actual_lm))



gg.lm <- ggplot(Pred_Actual_lm, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Multiple Linear Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))
gg.lm
```





```{r}

data.frame(
  R2 = R2(y_pred_lm, data_test$Happiness.Score),
  RMSE = RMSE(y_pred_lm, data_test$Happiness.Score),
  MAE = MAE(y_pred_lm, data_test$Happiness.Score)
)
```

## Support Vector Regression for Happyniess Score Prediction

### Train SVR model data_train

```{r}
library(e1071)

regressor_svr = svm(formula = Happiness.Score ~ .,
                data = data_train,
                type = 'eps-regression',
                kernel = 'radial')
```

### Predict datat_test happiness score by SVR model 

```{r}
# Predicting a new result
y_pred_svr = predict(regressor_svr,  newdata = data_test)

Pred_Actual_svr <- as.data.frame(cbind(Prediction = y_pred_svr, Actual = data_test$Happiness.Score))


Pred_Actual_lm.versus.svr <- cbind(Prediction.lm = y_pred_lm, Prediction.svr = y_pred_svr, Actual = data_test$Happiness.Score)


gg.svr <- ggplot(Pred_Actual_svr, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "SVR", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))
gg.svr
```

```{r}
data.frame(
  R2 = R2(y_pred_svr, data_test$Happiness.Score),
  RMSE = RMSE(y_pred_svr, data_test$Happiness.Score),
  MAE = MAE(y_pred_svr, data_test$Happiness.Score)
)
```




## Decision Tree Regression for Happyniess Score Prediction

### rain Decision Tree Regressio model with data_train

```{r}

library(rpart)
regressor_dt = rpart(formula = Happiness.Score ~ .,
                  data = data_train,
                  control = rpart.control(minsplit = 10))


```

### Predict datat_test happiness score with Decision Tree Regression 

```{r}
# Predicting a new result with Decision Tree Regression
y_pred_dt = predict(regressor_dt, newdata = data_test)

Pred_Actual_dt <- as.data.frame(cbind(Prediction = y_pred_dt, Actual = data_test$Happiness.Score))


gg.dt <- ggplot(Pred_Actual_dt, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Decision Tree Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))
gg.dt
```
```{r}

#install.packages("rpart.plot")
library(rpart.plot)
prp(regressor_dt)
```


```{r}

data.frame(
  R2 = R2(y_pred_dt, data_test$Happiness.Score),
  RMSE = RMSE(y_pred_dt, data_test$Happiness.Score),
  MAE = MAE(y_pred_dt, data_test$Happiness.Score)
)
```


## Random Forest Regression for Happyniess Score Prediction

### Train Random Forest Regression model with data_train

```{r}

library(randomForest)

x_train_rf<-select(dataset,-c("Happiness.Score"))

          
set.seed(1234)
regressor_rf = randomForest(x = x_train_rf,
                         y = dataset$Happiness.Score,
                         ntree = 500)


```

### Predict datat_test happiness score with Random Forest Regression 

```{r}
# Predicting a new result with Random Forest Regression
y_pred_rf = predict(regressor_rf, newdata = data_test)

Pred_Actual_rf <- as.data.frame(cbind(Prediction = y_pred_rf, Actual = data_test$Happiness.Score))


gg.rf <- ggplot(Pred_Actual_rf, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Random Forest Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))
gg.rf
```

```{r}
data.frame(
  R2 = R2(y_pred_rf, data_test$Happiness.Score),
  RMSE = RMSE(y_pred_rf, data_test$Happiness.Score),
  MAE = MAE(y_pred_rf, data_test$Happiness.Score)
)
```

## Model Evaluation 


```{r}
ggarrange(gg.lm, gg.svr, gg.dt, gg.rf, ncol = 2, nrow = 3)
```






# Data Modelling Classification Algorithm


## Feature Scaling 


```{r}

#defined a preprocess variable, which includes the two operations: center and scale

preProcess <- c("center","scale")

```


## Split into train set (70%) and test set (30%) 



```{r}

# Splitting the dataset into the Training set and Test set
set.seed(123) 

split=0.70
trainIndex <- createDataPartition(dataset_level$Happy.Level, p=split, list=FALSE) 
data_train <- dataset_level[ trainIndex,] 
data_test <- dataset_level[-trainIndex,]


```


## Cross validation 

```{r}
tc <- trainControl(method = "repeatedcv", number=10,#10-fold cross validation 
                   repeats = 10,classProbs = TRUE)
```


## K-Neighbors Classifier for predicting Happy Level</a>


### Train K-Nearest Neighbours model with data_train


```{r}


set.seed(123)
model_knn <- train(
  Happy.Level~., 
  data=data_train, 
  trControl=tc, 
  preProcess = preProcess,
  method="knn",
  metric='Accuracy',
  tuneLength=20
  ) 

model_knn



```

Accuracy of K-Nearest Neighbours model by running it on train data

```{r}

plot(model_knn)

```


### Predict happiness level by K-Nearest Neighbours model



```{r}

pred_knn <- predict(model_knn, data_test)

cm_knn<-confusionMatrix(pred_knn, data_test$Happy.Level)

cm_knn

```



### Feature Importance

```{r}

# Create object of importance of our variables 
knn_importance <- varImp(model_knn) 

# Create box plot of importance of variables
ggplot(data = knn_importance, mapping = aes(x = knn_importance[,1])) + # Data & mapping
  geom_boxplot() + # Create box plot
  labs(title = "Variable importance: K-Nearest Neighbours ") + # Title
  theme_light() # Theme
```

## Random Forest Classification model for predicting Happy Level


```{r}
model_rf <- train(Happy.Level~.,
                  data_train,
                  method="rf",
                  preProcess = preProcess,
                  trControl=tc)

model_rf

```


```{r}

plot(model_rf)
```





### Predict happiness Level by Random Forest Classification


```{r}
pred_rf <- predict(model_rf, data_test)

cm_rf<-confusionMatrix(pred_rf, data_test$Happy.Level)

cm_rf
 
```


Feature Importance


```{r}
# Create object of importance of our variables 
rf_importance <- varImp(model_rf) 

# Create box plot of importance of variables
ggplot(data = rf_importance, mapping = aes(x = rf_importance[,1])) + # Data & mapping
  geom_boxplot() + # Create box plot
  labs(title = "Variable importance: Random forest model") + # Title
  theme_light() # Theme
```



### Model Evaluation

```{r}

data.frame(
  accuracy_knn = cm_knn$overall[1],
  accuracy_rf =  cm_rf$overall[1]
)

```




# conclusion


## <a style="color:blue;">Happiness score Prediction (Regression Model)</a>

Random Forest Regression comes out with the best result compared to others, Support Vector Regression model and Multiple Linear Regression are good in prediction. And finally, Decision Tree was the worst algorithm to predict happiness scores.

## <a style="color:blue;">Happiness Level Prediction (Classification Model)</a>

Random Forest Classification is better than K-Neighbors Classifier model


# Reference